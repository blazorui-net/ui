@namespace BlazorBlueprint.Primitives.Sheet
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

@*
    SheetOverlay provides a background overlay for modal sheets.
    Can handle click-outside-to-close if configured.
*@

@if (Context.IsOpen)
{
    <div @ref="_overlayRef"
         id="@Context.OverlayId"
         @onclick="HandleClick"
         @attributes="AdditionalAttributes"
         data-state="@(Context.IsOpen ? "open" : "closed")">
        @ChildContent
    </div>
}

@code {
    [CascadingParameter]
    private SheetContext Context { get; set; } = null!;

    /// <summary>
    /// The content to render within the overlay (typically empty for a simple backdrop).
    /// </summary>
    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    /// <summary>
    /// Additional attributes to apply to the overlay div element.
    /// </summary>
    [Parameter(CaptureUnmatchedValues = true)]
    public Dictionary<string, object>? AdditionalAttributes { get; set; }

    /// <summary>
    /// Whether clicking the overlay should close the sheet.
    /// Default is true.
    /// </summary>
    [Parameter]
    public bool CloseOnClick { get; set; } = true;

    /// <summary>
    /// Event callback invoked when the overlay is clicked.
    /// </summary>
    [Parameter]
    public EventCallback<MouseEventArgs> OnClick { get; set; }

    private ElementReference _overlayRef;

    protected override void OnInitialized()
    {
        if (Context == null)
        {
            throw new InvalidOperationException(
                "SheetOverlay must be used within a Sheet component. " +
                "Ensure SheetOverlay is a child of a Sheet component.");
        }
    }

    private async Task HandleClick(MouseEventArgs args)
    {
        // Invoke custom click handler if provided
        if (OnClick.HasDelegate)
        {
            await OnClick.InvokeAsync(args);
        }

        // Close sheet if configured
        if (CloseOnClick)
        {
            Context.Close();
        }
    }

    public async ValueTask DisposeAsync()
    {
        await Task.CompletedTask;
    }
}
