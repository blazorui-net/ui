@namespace BlazorUI.Components.Slider
@using Microsoft.JSInterop
@inject IJSRuntime JS

<div @ref="_trackRef"
     role="slider"
     aria-valuemin="@Min"
     aria-valuemax="@Max"
     aria-valuenow="@CurrentValue"
     aria-disabled="@Disabled"
     tabindex="@(Disabled ? -1 : 0)"
     class="@CssClass"
     @onmousedown="HandleMouseDown"
     @onkeydown="HandleKeyDown">
    <div class="relative h-2 w-full grow overflow-hidden rounded-full bg-secondary">
        <div class="absolute h-full bg-primary"
             style="width: @(Percentage)%;">
        </div>
    </div>
    <div class="@ThumbClass"
         style="left: @(Percentage)%;"
         @onmousedown="HandleThumbMouseDown"
         @onmousedown:stopPropagation="true">
    </div>
</div>

@code {
    [Parameter]
    public double Value { get; set; }

    [Parameter]
    public EventCallback<double> ValueChanged { get; set; }

    [Parameter]
    public double DefaultValue { get; set; }

    [Parameter]
    public double Min { get; set; } = 0;

    [Parameter]
    public double Max { get; set; } = 100;

    [Parameter]
    public double Step { get; set; } = 1;

    [Parameter]
    public bool Disabled { get; set; }

    [Parameter]
    public SliderOrientation Orientation { get; set; } = SliderOrientation.Horizontal;

    [Parameter]
    public string? Class { get; set; }

    private ElementReference _trackRef;
    private double _internalValue;
    private bool _isDragging;
    private bool IsControlled => ValueChanged.HasDelegate;
    private double CurrentValue => IsControlled ? Value : _internalValue;
    private double Percentage => ((CurrentValue - Min) / (Max - Min)) * 100;

    protected override void OnInitialized()
    {
        _internalValue = DefaultValue;
    }

    private async Task SetValue(double value)
    {
        value = Math.Round(value / Step) * Step;
        value = Math.Max(Min, Math.Min(Max, value));

        if (IsControlled)
        {
            await ValueChanged.InvokeAsync(value);
        }
        else
        {
            _internalValue = value;
            StateHasChanged();
        }
    }

    private async Task HandleMouseDown(MouseEventArgs e)
    {
        if (Disabled) return;
        await UpdateValueFromMouse(e.ClientX);
    }

    private async Task HandleThumbMouseDown(MouseEventArgs e)
    {
        if (Disabled) return;
        _isDragging = true;
    }

    private async Task UpdateValueFromMouse(double clientX)
    {
        try
        {
            var rect = await JS.InvokeAsync<BoundingClientRect>("eval",
                $"(function() {{ var el = document.querySelector('[aria-valuenow=\"{CurrentValue}\"]'); if (el) {{ var rect = el.getBoundingClientRect(); return {{ left: rect.left, width: rect.width }}; }} return {{ left: 0, width: 100 }}; }})()");

            var percentage = (clientX - rect.Left) / rect.Width;
            var newValue = Min + (percentage * (Max - Min));
            await SetValue(newValue);
        }
        catch { }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (Disabled) return;

        var stepSize = Step;
        var largeStep = (Max - Min) / 10;

        switch (e.Key)
        {
            case "ArrowRight":
            case "ArrowUp":
                await SetValue(CurrentValue + stepSize);
                break;
            case "ArrowLeft":
            case "ArrowDown":
                await SetValue(CurrentValue - stepSize);
                break;
            case "PageUp":
                await SetValue(CurrentValue + largeStep);
                break;
            case "PageDown":
                await SetValue(CurrentValue - largeStep);
                break;
            case "Home":
                await SetValue(Min);
                break;
            case "End":
                await SetValue(Max);
                break;
        }
    }

    private string CssClass => BlazorUI.Components.Utilities.ClassNames.cn(
        "relative flex w-full touch-none select-none items-center",
        Disabled ? "opacity-50 cursor-not-allowed" : "cursor-pointer",
        Class
    );

    private string ThumbClass => BlazorUI.Components.Utilities.ClassNames.cn(
        "absolute block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors",
        "focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",
        "disabled:pointer-events-none disabled:opacity-50",
        "-translate-x-1/2 top-1/2 -translate-y-1/2"
    );

    private record BoundingClientRect(double Left, double Width);
}
