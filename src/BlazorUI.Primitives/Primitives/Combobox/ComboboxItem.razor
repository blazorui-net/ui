@namespace BlazorUI.Primitives.Combobox
@implements IDisposable

@* ComboboxItem primitive - headless selectable item *@
@if (_isVisible)
{
    <div @ref="_itemElement"
         id="@_itemId"
         role="option"
         aria-selected="@(_isFocused ? "true" : "false")"
         aria-disabled="@(Disabled ? "true" : "false")"
         data-focused="@(_isFocused)"
         data-disabled="@(Disabled)"
         @onclick="HandleClick"
         @onmouseenter="HandleMouseEnter"
         @attributes="AdditionalAttributes">
        @ChildContent
    </div>
}

@code {
    [CascadingParameter]
    public ComboboxContext Context { get; set; } = null!;

    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    /// <summary>
    /// The value associated with this item.
    /// </summary>
    [Parameter]
    public string? Value { get; set; }

    /// <summary>
    /// The text used for search filtering.
    /// If not provided, uses the Value.
    /// </summary>
    [Parameter]
    public string? SearchText { get; set; }

    /// <summary>
    /// Whether this item is disabled.
    /// </summary>
    [Parameter]
    public bool Disabled { get; set; }

    /// <summary>
    /// Callback invoked when this item is selected.
    /// </summary>
    [Parameter]
    public EventCallback OnSelect { get; set; }

    /// <summary>
    /// Additional attributes to apply to the item element.
    /// </summary>
    [Parameter(CaptureUnmatchedValues = true)]
    public Dictionary<string, object>? AdditionalAttributes { get; set; }

    private ElementReference _itemElement;
    private int _index = -1;
    private string _itemId = string.Empty;
    private bool _isFocused;
    private bool _isVisible = true;

    protected override void OnInitialized()
    {
        if (Context == null)
        {
            throw new InvalidOperationException($"{nameof(ComboboxItem)} must be used within a {nameof(Combobox)} component.");
        }

        // Register with context
        _index = Context.RegisterItem(
            value: Value,
            searchText: SearchText ?? Value,
            disabled: Disabled,
            onSelect: OnSelect
        );

        _itemId = Context.GetItemId(_index);

        // Subscribe to context state changes
        Context.OnStateChanged += HandleContextStateChanged;

        // Initial visibility check
        UpdateVisibility();
    }

    protected override void OnParametersSet()
    {
        base.OnParametersSet();

        // Update registration when parameters change (especially OnSelect callback)
        // This ensures callbacks stay current when parent re-renders with new lambdas
        if (_index >= 0 && Context != null)
        {
            Context.UpdateItem(
                index: _index,
                value: Value,
                searchText: SearchText ?? Value,
                disabled: Disabled,
                onSelect: OnSelect
            );
        }
    }

    private async Task HandleClick()
    {
        if (Disabled) return;

        await Context.SelectItemByValue(Value ?? string.Empty);
    }

    private void HandleMouseEnter()
    {
        if (Disabled) return;

        // Set focus when mouse enters (for keyboard-mouse mixed navigation)
        var filteredItems = Context.GetFilteredItems();
        var thisItem = Context.GetItemByIndex(_index);

        if (thisItem != null)
        {
            var indexInFiltered = filteredItems.IndexOf(thisItem);
            if (indexInFiltered >= 0)
            {
                Context.SetFocusedIndex(indexInFiltered);
            }
        }
    }

    private void HandleContextStateChanged()
    {
        // Update focused state by finding this item's position in filtered list
        var filteredItems = Context.GetFilteredItems();
        var thisItem = Context.GetItemByIndex(_index);

        if (thisItem != null)
        {
            // Find this item's position in the filtered list
            var indexInFiltered = filteredItems.IndexOf(thisItem);
            _isFocused = indexInFiltered >= 0 && Context.FocusedIndex == indexInFiltered;
        }
        else
        {
            _isFocused = false;
        }

        // Update visibility based on filter
        UpdateVisibility();

        StateHasChanged();
    }

    private void UpdateVisibility()
    {
        var thisItem = Context.GetItemByIndex(_index);
        if (thisItem == null)
        {
            _isVisible = false;
            return;
        }

        // Apply filter directly to this item, not via filtered list
        if (string.IsNullOrWhiteSpace(Context.SearchQuery))
        {
            _isVisible = true;
        }
        else if (Context.FilterFunction != null)
        {
            _isVisible = Context.FilterFunction(thisItem, Context.SearchQuery);
        }
        else
        {
            _isVisible = thisItem.SearchText?.Contains(Context.SearchQuery, StringComparison.OrdinalIgnoreCase) ?? false;
        }
    }

    public void Dispose()
    {
        if (Context != null && _index >= 0)
        {
            Context.UnregisterItem(_index);
            Context.OnStateChanged -= HandleContextStateChanged;
        }
    }
}
